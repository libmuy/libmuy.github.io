<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>カーネルのパフォーマンス計測ツール：perf - LIBMUY</title>
    <link rel="stylesheet" href="/assets/prism/prism.css">
    <script src="/assets/prism/prism.js"></script>

    <link rel="shortcut icon" href="/assets/images/logo_black_small.png">
    <link rel="icon" href="/assets/images/logo_black_small.png">

    <link rel="stylesheet" href="/assets/css/style.css">
    <link rel="canonical" href="/kernel/kernel-perf.html">

    <script src="https://kit.fontawesome.com/45a69050db.js" crossorigin="anonymous"></script>

    <meta name="keywords" content="カーネルのパフォーマンス計測ツール：perf, LIBMUY, ">
    <meta name="description" content="">
    <!-- Begin Jekyll SEO tag v2.7.1 -->
<title>カーネルのパフォーマンス計測ツール：perf | Libmuy’s Blog</title>
<meta name="generator" content="Jekyll v4.2.1" />
<meta property="og:title" content="カーネルのパフォーマンス計測ツール：perf" />
<meta name="author" content="Libmuy" />
<meta property="og:locale" content="ja_JP" />
<meta name="description" content="Linux Kernelにあるパフォーマンス計測機能perfに関するメモ" />
<meta property="og:description" content="Linux Kernelにあるパフォーマンス計測機能perfに関するメモ" />
<link rel="canonical" href="http://0.0.0.0:4000/kernel/kernel-perf.html" />
<meta property="og:url" content="http://0.0.0.0:4000/kernel/kernel-perf.html" />
<meta property="og:site_name" content="Libmuy’s Blog" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2018-06-22T00:00:00+09:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="カーネルのパフォーマンス計測ツール：perf" />
<meta name="twitter:site" content="@libmuy" />
<meta name="twitter:creator" content="@Libmuy" />
<meta property="fb:admins" content="libmuy" />
<meta property="article:publisher" content="libmuy" />
<script type="application/ld+json">
{"datePublished":"2018-06-22T00:00:00+09:00","description":"Linux Kernelにあるパフォーマンス計測機能perfに関するメモ","mainEntityOfPage":{"@type":"WebPage","@id":"http://0.0.0.0:4000/kernel/kernel-perf.html"},"url":"http://0.0.0.0:4000/kernel/kernel-perf.html","@type":"BlogPosting","author":{"@type":"Person","name":"Libmuy"},"publisher":{"@type":"Organization","logo":{"@type":"ImageObject","url":"http://0.0.0.0:4000/assets/images/logo_black_small.png"},"name":"Libmuy"},"headline":"カーネルのパフォーマンス計測ツール：perf","dateModified":"2018-06-22T00:00:00+09:00","@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->

</head>

<body class="index">
    <nav>
        <a href="/">
            <img src="/assets/images/logo.svg">
            <span>LIBMUY</span>
        </a>
        <!-- 
            <ul class="nav-links">
                <li><a href="#">Home</a></li>
                <li><a href="#">About</a></li>
                <li><a href="#">Service</a></li>
                <li><a href="#">Contact</a></li>
            </ul> -->


        <div class="menu">
            <div class="bar bar1"></div>
            <div class="bar bar2"></div>
            <div class="bar bar3"></div>
        </div>

    </nav>
    <div class="container">
        <header id="header" itemscope="" itemtype="https://schema.org/WPHeader">
    <div id="head-in">
            <div id="sitename">
                <a href="/" itemprop="url"><img src="/assets/images/logo.svg" alt="" width="150" height="150"
                        class="onepoint" itemprop="image" sizes="(max-width: 150px) 100vw, 150px">
                    <span itemprop="name about">LIBMUY</span>
                </a>
            </div>
    </div>
</header>
        <!-- <link rel="stylesheet" href="/assets/css/post.css"> -->

<div id="primary" class="clearfix">
    <div id="left-side">
    <div id="side-fixed">
        <div class="title">目次</div>
        <ul id="" class="toc_list">
<li class=" toc-h1"><a href="#カーネルオプション">カーネルオプション</a></li>
<li class=" toc-h1"><a href="#tips">Tips</a></li>
<li class=" toc-h1"><a href="#perf-tools-ビルドオプション">perf tools ビルドオプション</a></li>
<li class=" toc-h1"><a href="#flamegraph">FlameGraph</a>
<ul>
<li class=" toc-h3"><a href="#prepare-flamegraph">Prepare FlameGraph</a></li>
<li class=" toc-h3"><a href="#get-performance-data-execute-in-target-system">get performance data (execute in target system)</a></li>
<li class=" toc-h3"><a href="#generate-flamegraph">Generate FlameGraph</a></li>
</ul>
</li>
</ul>
    </div>
</div>
<!--/#right-side-->
    <main id="main">
        <article>
            <div id="core" class="grid">
                <div itemprop="mainEntityOfPage" id="mainEntity"
                    class="post post-109 type-post status-publish format-standard has-post-thumbnail hentry category-server tag-debian tag-linux tag-omv tag-openmediavault tag-server tag-wordpress ja">
                    <header id="article-header">
                        <h1 class="entry-title" itemprop="headline name">カーネルのパフォーマンス計測ツール：perf</h1>
                    </header>
                    <div class="clearfix">
                        <p class="meta">
                            <i class="far fa-clock"></i>
                            <span class="date published">
                                <time class="entry-date updated" datetime="2018-06-22T00:00:00+09:00"
                                    itemprop="datePublished">
                                    22 Jun 2018
                                </time>
                            </span>
                            <i class="fas fa-redo-alt"></i>
                            <span class="date">
                                <meta itemprop="dateModified" content="2021-10-07T00:47:14+09:00">
                                07 Oct 2021
                            </span>
                        </p>

                        <div id="toc_container"><span class="toc_title">Contents</span><input id="toc_toggle"
                                type="checkbox" checked="checked"><label class="toc_toggle" for="toc_toggle"></label>
                            <ul id="" class="toc_list">
<li class=" toc-h1"><a href="#カーネルオプション">カーネルオプション</a></li>
<li class=" toc-h1"><a href="#tips">Tips</a></li>
<li class=" toc-h1"><a href="#perf-tools-ビルドオプション">perf tools ビルドオプション</a></li>
<li class=" toc-h1"><a href="#flamegraph">FlameGraph</a>
<ul>
<li class=" toc-h3"><a href="#prepare-flamegraph">Prepare FlameGraph</a></li>
<li class=" toc-h3"><a href="#get-performance-data-execute-in-target-system">get performance data (execute in target system)</a></li>
<li class=" toc-h3"><a href="#generate-flamegraph">Generate FlameGraph</a></li>
</ul>
</li>
</ul>
                        </div>

                        <p>Linux Kernelにあるパフォーマンス計測機能<code>perf</code>に関するメモ</p>

<h1 id="カーネルオプション">カーネルオプション</h1>

<p><code>CONFIG_PERF_EVENTS</code>
General setup → Kernel Performance Events And Counters → Kernel performance events and counters</p>

<h1 id="tips">Tips</h1>

<p>タイマー周波数(Kernel Features → Timer frequency / CONFIG_HZ=1000)を1000HZにする（sample pointが少なくなるため）</p>

<h1 id="perf-tools-ビルドオプション">perf tools ビルドオプション</h1>

<p><code>EXTRA_CFLAGS=--sysroot=/home/.../output/host/arm-buildroot-linux-gnueabihf/sysroot make tools/perf</code></p>

<h1 id="flamegraph">FlameGraph</h1>

<h3 id="prepare-flamegraph">Prepare FlameGraph</h3>
<ol>
  <li><code>git clone https://github.com/brendangregg/FlameGraph</code></li>
  <li><code>cd FlameGraph</code></li>
</ol>

<h3 id="get-performance-data-execute-in-target-system">get performance data (execute in target system)</h3>
<ol>
  <li><code>perf record -a -F 999 -g -- iperf -c 192.168.137.2</code> <br />
option <code>-a</code> is important, this will make perf see the global environment.</li>
  <li><code>perf script &gt; iperf.script.bm25.send</code></li>
  <li><code>scp iperf.script.bm25.send bjn@192.168.137.2:~/wk/FlameGraph/</code></li>
</ol>

<h3 id="generate-flamegraph">Generate FlameGraph</h3>
<ol>
  <li><code>cat iperf.script.bm25.send | ./stackcollapse-perf.pl &gt; out.iperf-folded.bm25.send</code></li>
  <li><code>./flamegraph.pl out.iperf-folded.bm25.send  &gt; iperf.bm25.send.svg</code></li>
</ol>


                    </div>
                    <div class="meta-box">
                        <p class="meta meta-u">
                            
                            
                            
                            



<span class="category items" itemprop="keywords">
    
    
    
    
    <i class="fas fa-folder-open"></i>
    <a href="/category/kernel/">カーネル</a>
    
    
</span>
                            <span class="tags items" itemprop="keywords">

    
    
    <span class="first-item">
        <i class="fas fa-tags"></i>
        <a href="/tag/performance/">performance</a>
    </span>
    
    
    
    <span class="break">,</span>
    <a href="/tag/perf/">perf</a>
    
    
    
    <span class="break">,</span>
    <a href="/tag/kernel/">kernel</a>
    
    
    
    <span class="break">,</span>
    <a href="/tag/Linux/">Linux</a>
    
    
</span>
                        </p>
                    </div>
                </div>
            </div>
        </article>
    </main>
    
    <div id="right-side">
    <div id="side-fixed">
        <div class="title ">
            <a href="/">HOME</a>
        </div>
        

        
        
        


        <div class="category-lv1 ">
            <a href="/category/linux">Linux(4)</a>
        </div>
        
        
        
        


        <div class="category-lv1 current">
            <a href="/category/kernel">カーネル(5)</a>
        </div>
        
        
        
        


        <div class="category-lv1 ">
            <a href="/category/network">ネットワーク(2)</a>
        </div>
        
        
        
        


        <div class="category-lv1 ">
            <a href="/category/web">Web関連(2)</a>
        </div>
        
        
        
        


        <div class="category-lv1 ">
            <a href="/category/tools">ツール(2)</a>
        </div>
        
        
        
        


        <div class="category-lv1 ">
            <a href="/category/devtips">開発Tips(4)</a>
        </div>
        
        
        
        


        <div class="category-lv1 ">
            <a href="/category/shell">シェル(2)</a>
        </div>
        
        
    </div>
</div>
<!--/#right-side-->
</div>
    </div>
    <button onclick="goToTopFunction()" id="goToTopBtn" title="Go to top">Top</button>
    <script type="text/javascript" src="/assets/main.js"></script>    <div id="footer" itemscope="" itemtype="https://schema.org/WPFooter">
    <footer>
        <div id="copyright">
            <p class="copy">Copyright © <span itemprop="copyrightYear">2021</span>&nbsp;<span
                    itemprop="copyrightHolder name">Libmuy</span> All Rights Reserved.</p>
        </div>
    </footer>
</div>
</body>

</html>